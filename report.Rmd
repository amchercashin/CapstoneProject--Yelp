---
title: "Restaurant busyness attributes effects on business star rating"
author: "Alexandr Cherkashin"
date: "4 ноября 2015 г."
output: html_document
---

```{r data loading and munging, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
library(caret)
# Reading data----

business <- readRDS("./data/businessRDS")

#EXPLORATORY-----
bars <- sapply(business$categories, function(x) "Bars" %in% x)
bars <- flatten(business[bars,])
restaurants <- sapply(business$categories, function(x) "Restaurants" %in% x)
restaurants <- flatten(business[restaurants,])

#DATA MUNGING
# Convinient column names----
colnames(restaurants) <- make.names(colnames(restaurants))

#Noise level attribute to integer level----
restaurants$attributes.Noise.Level[restaurants$attributes.Noise.Level == "quiet"] <- 0
restaurants$attributes.Noise.Level[restaurants$attributes.Noise.Level == "average"] <- 1
restaurants$attributes.Noise.Level[restaurants$attributes.Noise.Level == "loud"] <- 2
restaurants$attributes.Noise.Level[restaurants$attributes.Noise.Level == "very_loud"] <- 3
restaurants$attributes.Noise.Level <- as.integer(restaurants$attributes.Noise.Level)

#Parking to three categories: free, paid, no ----
parkingCols <- grep("Parking", colnames(restaurants), value = TRUE)
restaurants[,parkingCols][is.na(restaurants[,parkingCols])] <- "n_a"
restaurants$parking <- ifelse(restaurants$attributes.Parking.garage == "FALSE" &
                           restaurants$attributes.Parking.validated == "FALSE" &
                           restaurants$attributes.Parking.lot == "FALSE" &
                           restaurants$attributes.Parking.valet == "FALSE" &
                           restaurants$attributes.Parking.street == "FALSE", "no", 
                           ifelse(restaurants$attributes.Parking.garage == "TRUE" |
                                  restaurants$attributes.Parking.validated == "TRUE" |
                                  restaurants$attributes.Parking.lot == "TRUE" |
                                  restaurants$attributes.Parking.valet == "TRUE", "yes", 
                                  ifelse(restaurants$attributes.Parking.street == "TRUE", "street", NA)))
restaurants$parking <- factor(restaurants$parking, levels = c("no", "yes", "street"))

#Making an new atttribute type of restaurant busyness: sportbar, bar, restaurant-----
sportbars <- sapply(restaurants$categories, function(x) "Sports Bars" %in% x)
bars <- sapply(restaurants$categories, function(x) !"Sports Bars" %in% x & "Bars" %in% x)
restaurants$cat <- ifelse(sportbars, "Sports Bar", ifelse(bars, "Bar", "Restaurant"))
restaurants$cat <- factor(restaurants$cat, levels = c("Restaurant", "Sports Bar", "Bar"))

#Flatten Accepts credit cars attribute----
restaurants$attributes.Accepts.Credit.Cards <- ifelse(sapply(restaurants$attributes.Accepts.Credit.Cards, length) == 0, NA, 
                                                      unlist(restaurants$attributes.Accepts.Credit.Cards))

#Dealing with categories vars----
cat2 <- sapply(restaurants$categories, function(x) {
        if (sum(x=="Afghan")>0|sum(x=="African")>0|sum(x=="Asian Fusion")>0|sum(x=="Bangladeshi")>0|sum(x=="Basque")>0|
            sum(x=="Bavarian")>0|sum(x=="Belgian")>0|sum(x=="British")>0|sum(x=="aCajun/Creole")>0|sum(x=="Cambodian")>0|
            sum(x=="Cantonese")>0|sum(x=="Cuban")>0|sum(x=="Egyptian")>0|sum(x=="Ethiopian")>0|sum(x=="French")>0|
            sum(x=="German")>0|sum(x=="Greek")>0|sum(x=="Hawaiian")>0|sum(x=="Himalayan/Nepalese")>0|sum(x=="Hungarian")>0|
            sum(x=="Indian")>0|sum(x=="Indonesian")>0|sum(x=="Irish")>0|sum(x=="Italian")>0|sum(x=="Japanese")>0|
            sum(x=="Korean")>0|sum(x=="Latin American")>0|sum(x=="Lebanese")>0|sum(x=="Malaysian")>0|sum(x=="Mediterranean")>0|
            sum(x=="Arabian")>0|sum(x=="Argentine")>0|sum(x=="Australian")>0|sum(x=="Brazilian")>0|sum(x=="Caribbean")>0|
            sum(x=="Arabian")>0|sum(x=="Argentine")>0|sum(x=="Australian")>0|sum(x=="Brazilian")>0|sum(x=="Caribbean")>0|
            sum(x=="Chinese")>0|sum(x=="Colombian")>0|sum(x=="Czech")>0|sum(x=="Eastern European")>0|sum(x=="Eastern German")>0|
            sum(x=="Ethnic Food")>0|sum(x=="Filipino")>0|sum(x=="Czech")>0|sum(x=="Haitian")>0|sum(x=="Iberian")>0|
            sum(x=="Laotian")>0|sum(x=="Middle Eastern")>0|sum(x=="Modern European")>0|sum(x=="Mongolian")>0|sum(x=="Moroccan")>0|
            sum(x=="Oriental")>0|sum(x=="Pakistani")>0|sum(x=="Persian/Iranian")>0|sum(x=="Peruvian")>0|sum(x=="Polish")>0|
            sum(x=="Portuguese")>0|sum(x=="Russian")>0|sum(x=="Scandinavian")>0|sum(x=="Scottish")>0|sum(x=="Shanghainese")>0|
            sum(x=="Singaporean")>0|sum(x=="Southern")>0|sum(x=="Spanish")>0|sum(x=="Szechuan")>0|sum(x=="Taiwanese")>0|
            sum(x=="Thai")>0|sum(x=="Trinidadian")>0|sum(x=="Turkish")>0|sum(x=="Ukrainian")>0|sum(x=="Uzbek")>0|
            sum(x=="Venezuelan")>0|sum(x=="Vietnamese")>0|sum(x=="Turkish")>0|sum(x=="Ukrainian")>0|sum(x=="Uzbek")>0) {
                "ThemedOther"}
        else {if(sum(x=="American (New)")>0|sum(x=="American (Traditional)")>0) {"ThemedAmerican"}
                else {if (sum(x=="Mexican")>0|sum(x=="Tex-Mex")>0) {"ThemedOther"}
                        else "NotThemed"}
                }
})

cat1 <- sapply(restaurants$categories, function(x) {
        if (sum(x=="Buffets")>0) "Buffets"
        else if(sum(x=="Fast Food")>0|sum(x=="Chicken Wings")>0|sum(x=="Burgers")>0|sum(x=="Pizza")>0) "Fast Food"
                #else if (sum(x=="Restaurants")>0) "Restaurants"
                        else if (sum(x=="Bars")>0|sum(x=="Pubs")>0|sum(x=="Irish Pub")>0) "Bars"
                                else if (sum(x=="Cafes")>0) "Cafes"
                                        else "Other"
        
})

#Geographocals points----
library(ggmap)
cities<-c('Edinburgh, UK', 'Karlsruhe, Germany', 'Montreal, Canada', 'Waterloo, Canada', 
          'Pittsburgh, PA', 'Charlotte, NC', 'Urbana-Champaign, IL', 'Phoenix, AZ', 'Las Vegas, NV', 'Madison, WI')
city_centres<-geocode(cities)
geo_cluster<-kmeans(restaurants[,c('longitude','latitude')],city_centres)
city2<- factor(geo_cluster$cluster, levels=1:10, labels = cities)
region <- ifelse(geo_cluster$cluster<=2, "Europe", ifelse(geo_cluster$cluster<=4, "Canada", "USA"))

#Sorting out vars with lots of NA----        
na_cols <- sapply(restaurants, function(x) sum(is.na(x))) / nrow(restaurants) > 0.3
restaurants <- restaurants[, !na_cols]; rm(na_cols)

#Sorting out near zero variance vars----        
nz_attr <- nearZeroVar(restaurants[,14:46])
restaurants <- restaurants[, -(nz_attr+13)]; rm(nz_attr)

#Determine features----
feature_names <- colnames(restaurants)[14:36]
feature_names <- feature_names[!(feature_names %in% parkingCols)]
feature_names <- feature_names[!grepl("Good.For", feature_names)]
feature_names <- feature_names[!grepl("Good.for", feature_names)]
feature_names <- feature_names[!grepl("Ambience", feature_names)]

comp_cases <- complete.cases(restaurants[, feature_names])
prevCat <- sapply(restaurants$categories, function(x) ifelse(x[[1]]=="Restaurants" & length(x)>1, x[[2]], x[[1]]))
```

# Introduction

This report provides an attempt to find some objective restaurant characteristics which affects business star rating. There is no goal of building comprehensive predictive model. Instead there is an attempt to keeping in mind collinearity possobilities identify meaningful attributes that busyness of type restaurants could deal with to improve their star rating on Yelp.

# Methods and Data

### Data
In analysis we will use Yelp business dataset. This dataset contains `star` variable that is an averaged business star rating from 1 to 5 star rounded to half of a star. It will be our response variable. As we interesed in businesses with type "restaurant" we'll take into analysis only observations with string "Restaurants" in `categories` variable.

In addition dataset contain several busyness characteristics some of them we will use as predictors. There are differents kinds of variables. Some of them we will tranform:

1. From latitude and longitude we'll generate `region` variable wich can take three different values: USA, Canada, Europe.
2. `attributes.Noise.Level` will be encoded into integer,  from "quiet" to "very_loud"" into `0:3`.
3. Attributes related to *parking* we will transform to `parking` variable with 3 different values: "no"" if there is no parking avalible, "yes" if there are some parking option exept it is not parking street, "street" if there is parking street there.
4. From `categories` var there would be an attempt to make var with some sort of geographic theme or cuisine: `ThemedAmerican`, `ThemedOther` - al other regional themes, and `NotThemed`.
5. Another attemp of categorization based on `categories` variable would be type of restaurant business: `Buffets`, `Fast Food`, `Bars`, `Cafes`, `Other`.
6. `attributes.Alcohol` we'll simplify to lwo level factor: `YES` - if there is some, otherwise - `NO`.

Other variables will be taken from dataset without tranformation.

There are some variables which containes "Good.For" or "Ambience" substrings in their names. Such vars appears a little vague on what they means and how they were measured. In this report we will not take them into analisys, concentrating on more clear some.

There will be no attempts to impute missing values. Only `complete.cases` will be taken. Also we will not use vars with near zero variance.

For the details about feature engeneering and other data preparation steps please refer to R code in "report.Rmd"" file at: https://github.com/amchercashin/CapstoneProject--Yelp/tree/business-analisys 

### Methods

There were some hesitaion on what model to choose. Actually, our response: `stars`, which measure in halfs of a star from 0 to 5, could be interpreted as an ordered factor variable. It has an ordered nature for sure, it is an averaged users star rating rounded to half of a star, there is no clue that the "distances" between star halfs are the same despite their location. So models like [ordered logit](https://web.stanford.edu/~hastie/Papers/ordered.pdf) or [ordered probit](http://web.stanford.edu/class/polisci203/ordered.pdf) could be used.

But after all consideration choice was made in favor of linear models. The main point of this is that the goal of this work is not to build a good predictive model. Instead, we'd like to find what affects star rating most and try to infer the effect and *interpret* it. So the interpretability is what most valuable, and linear model is really easyer to interpret. So will use linear models and refer to `star` variable like it was a real number.

# Results

With variables wich left after data preparation and feature engeneering we build the linear model, let's look at `summary` of it:

```{r model, echo=FALSE}
summary(lm(formula = stars ~ region + cat1 + cat2 + attributes.Outdoor.Seating + parking + alco + 
                   cat1:alco + parking:alco + I(attributes.Price.Range^4) + I(attributes.Noise.Level^2), 
           data = restaurants, subset = comp_cases))
```

The impact of variables which are absent in table was considered both small and not very sustainable.

Let's look at the model closer. The *intercept* - the baseline - is an Cafe in Europe whithout alcohol, with no regional theme, without outdoor seating and without any parking option.

We see that there are different intercepts of star rating for different regions and different categories of restaurans. There is a tendancy to rate them more in Europe, in Canada mean rating is smaller by 0.17 os a star and in USA further by next 0.13. What is interesting is such a negative effect of being fast food and buffet *exept* you are offering alcohol there! As for cafes alcohol is a bad idea and for other restaurants it is ok.

Parking usually gives significant boost to score, especially if there is a parking street. But.. the effect shrinks by half if you offer alcohol there.

THere is a tendancy to rate restaurants with American theme litlle less then other. The effect is small, but still. Outdoor seatings gives a little plus to overall rating.

It is interesting how noise levels affects rating. It looks like that negative effect of increasing noise is accelerative in nature: every next level of loudness give an more and more negative effect on ratig. From different approxiamtion we choose a one simpe: quadratic.

```{r anova, echo=FALSE}
anova(lm(formula = stars ~ I(attributes.Noise.Level), data = restaurants, subset = comp_cases), lm(formula = stars ~ I(attributes.Noise.Level^2), data = restaurants, subset = comp_cases), lm(formula = stars ~ I(attributes.Noise.Level^3), data = restaurants, subset = comp_cases), lm(formula = stars ~ I(attributes.Noise.Level^4), data = restaurants, subset = comp_cases), lm(formula = stars ~ exp(attributes.Noise.Level), data = restaurants, subset = comp_cases))
```

So it looks like that people tolerance to the noise is falling rapidly. There is a half of a star between "quite" and "very_loud" levels: 3 ^ 2 * 0.0532 = 0.48, and most of it is beetween very loud and average levels. If you have a very loud enviermonet you can gain 0.27 of a star goind one step towards quite and 0.16 more going one step further. We have found no collinearity with other availible variables, but there could be some with different types of restautants. Another question is how noise levels was measured.

There is a small but sustainable positive effect of price range. It is non linear too, but still it is small.

```{r lm noise, echo=FALSE}
summary(lm(formula = stars ~ I(attributes.Noise.Level^2), data = restaurants, subset = comp_cases))
```

# Discussion

First of all, an adjusted R-squared of presented model is 0.1242. So the model describes only 12.5% of variance in restaurants ratings. Suerly every restaurant is different and there are much more important things like quality of food, quality of service, good location spots and others and which really should describe the rest.

But as we see there are some objective, impersonal and measurable factors which could also affect rating. It looks like that working on them could increase it.

Certainly there are numerous interaction possibilities wich are hard to explore. The main conclusion that we draw from this analisys was that it is better to concentrate on even more narrow theme. For an example like exploaring only for one narrow type of of restaurant in specific city. And if you suceed you can compair you result to another types or cities. Also it looks like that such separate analysys could have more value.

There was some simplifications in feature desing. The main reason was to decrease feature space for better interpretability. That was the price for choosing a broad question. `cat2` variable is an example: surely it should be more specific. Typology based on `categories` original variable is a deep question by itself  

Another point: there are some doubts about several variables. Actually it could be that pricerange variable with combinations for an example with alcohol and categories - all are signs of some hidden "type of restaurant" variable.













This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
summary(cars)
```

You can also embed plots, for example:

```{r, echo=FALSE}
plot(cars)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
